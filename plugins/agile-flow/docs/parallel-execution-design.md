# æ•æ·æµç¨‹å¹¶è¡ŒåŒ–è®¾è®¡æ–¹æ¡ˆ

## å½“å‰é—®é¢˜

### ç°çŠ¶ï¼šå®Œå…¨ä¸²è¡Œ
```
éœ€æ±‚A â†’ æŠ€æœ¯è®¾è®¡A â†’ å¼€å‘A â†’ æµ‹è¯•A â†’ éœ€æ±‚B â†’ æŠ€æœ¯è®¾è®¡B â†’ å¼€å‘B â†’ æµ‹è¯•B â†’ ...
```

**é—®é¢˜**ï¼š
- å¼€å‘ä»»åŠ¡ A æ—¶ï¼Œéœ€æ±‚åˆ†æ B å¿…é¡»ç­‰å¾…
- æµ‹è¯•ä»»åŠ¡ A æ—¶ï¼Œå¼€å‘ä»»åŠ¡ B å¿…é¡»ç­‰å¾…
- æ€»è€—æ—¶ = æ‰€æœ‰ä»»åŠ¡æ—¶é—´ä¹‹å’Œ
- èµ„æºåˆ©ç”¨ç‡ä½ï¼ˆå¤§éƒ¨åˆ† subagent åœ¨ç­‰å¾…ï¼‰

---

## å¹¶è¡ŒåŒ–åˆ†æ

### å¯å¹¶è¡Œçš„é˜¶æ®µ

| é˜¶æ®µ | å¹¶è¡Œæ€§ | å†²çªé£é™© | å¹¶è¡Œç­–ç•¥ |
|------|--------|----------|----------|
| **éœ€æ±‚åˆ†æ** | âœ… é«˜ | âš ï¸ ä½ | å¤šä¸ªéœ€æ±‚åŒæ—¶åˆ†æ |
| **æŠ€æœ¯è®¾è®¡** | âœ… é«˜ | âš ï¸ ä½ | ç‹¬ç«‹åŠŸèƒ½åŒæ—¶è®¾è®¡ |
| **TDD å¼€å‘** | âœ… ä¸­ | ğŸ”´ é«˜ | éœ€è¦æ–‡ä»¶å†²çªæ£€æµ‹ |
| **E2E æµ‹è¯•** | âœ… é«˜ | âš ï¸ ä¸­ | éœ€è¦ç«¯å£ç®¡ç† |

### å†²çªç±»å‹

#### 1. ä»£ç å†²çªï¼ˆé«˜é£é™©ï¼‰
```
Subagent A ä¿®æ”¹: src/api/users.py
Subagent B ä¿®æ”¹: src/api/users.py
â†’ Git merge å†²çª
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ–‡ä»¶çº§é”æœºåˆ¶
- ä¿®æ”¹å‰æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å ç”¨
- æŒ‰æ¨¡å—/ç›®å½•åˆ†é…ä»»åŠ¡

#### 2. èµ„æºç«äº‰ï¼ˆä¸­é£é™©ï¼‰
```
Subagent A å¯åŠ¨: npm run dev (ç«¯å£ 3000)
Subagent B å¯åŠ¨: npm run dev (ç«¯å£ 3000)
â†’ ç«¯å£å†²çª
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åŠ¨æ€ç«¯å£åˆ†é…
- ä½¿ç”¨ Docker å®¹å™¨éš”ç¦»
- å…±äº«å¼€å‘æœåŠ¡å™¨

#### 3. ä»»åŠ¡ä¾èµ–ï¼ˆä¸­é£é™©ï¼‰
```
ä»»åŠ¡ A: å®ç°ç”¨æˆ· API
ä»»åŠ¡ B: è°ƒç”¨ç”¨æˆ· API
â†’ B å¿…é¡»ç­‰å¾… A å®Œæˆ
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ„å»ºä»»åŠ¡ä¾èµ–å›¾
- æ‹“æ‰‘æ’åºç¡®å®šæ‰§è¡Œé¡ºåº
- åªå¹¶è¡Œæ‰§è¡Œæ— ä¾èµ–çš„ä»»åŠ¡

#### 4. çŠ¶æ€ä¸ä¸€è‡´ï¼ˆä½é£é™©ï¼‰
```
Subagent A: å†™å…¥ TASKS.json
Subagent B: åŒæ—¶å†™å…¥ TASKS.json
â†’ æ•°æ®ç«äº‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ–‡ä»¶é”ï¼ˆflockï¼‰
- åŸå­å†™å…¥
- ä½¿ç”¨æ•°æ®åº“æ›¿ä»£ JSON

---

## å¹¶è¡Œæ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆ 1ï¼šæ™ºèƒ½ç®¡é“ï¼ˆæ¨èï¼‰

```
                    â”Œâ”€ éœ€æ±‚åˆ†æ A â”€â”
                    â”œâ”€ éœ€æ±‚åˆ†æ B â”€â”¤
                    â””â”€ éœ€æ±‚åˆ†æ C â”€â”˜
                         â†“
                    [ä¾èµ–åˆ†æ]
                         â†“
         â”Œâ”€ æŠ€æœ¯è®¾è®¡ A â”€â”´â”€ æŠ€æœ¯è®¾è®¡ B â”€â”
         â””â”€ æŠ€æœ¯è®¾è®¡ C â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
              [æ–‡ä»¶å†²çªæ£€æµ‹]
                    â†“
    â”Œâ”€ å¼€å‘ A (ç‹¬ç«‹æ¨¡å—) â”€â”´â”€ å¼€å‘ B (ç‹¬ç«‹æ¨¡å—) â”€â”
    â””â”€ å¼€å‘ C (ç­‰å¾… A) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
              [å¹¶è¡Œæµ‹è¯•]
    â”Œâ”€ æµ‹è¯• A â”€â”´â”€ æµ‹è¯• B â”€â”´â”€ æµ‹è¯• C â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
1. **ä»»åŠ¡ä¾èµ–å›¾**ï¼šè‡ªåŠ¨åˆ†æä»»åŠ¡ä¾èµ–å…³ç³»
2. **æ™ºèƒ½åˆ†ç»„**ï¼šå°†æ— ä¾èµ–ä»»åŠ¡åˆ†åˆ°åŒä¸€ç»„
3. **æ–‡ä»¶é”**ï¼šé˜²æ­¢ä»£ç å†²çª
4. **ç«¯å£æ± **ï¼šåŠ¨æ€åˆ†é…ç«¯å£

### æ–¹æ¡ˆ 2ï¼šæ³³é“å¹¶è¡Œ

```
æ³³é“ 1: éœ€æ±‚ â†’ è®¾è®¡ â†’ å¼€å‘ â†’ æµ‹è¯• (æ¨¡å— A)
æ³³é“ 2: éœ€æ±‚ â†’ è®¾è®¡ â†’ å¼€å‘ â†’ æµ‹è¯• (æ¨¡å— B)
æ³³é“ 3: éœ€æ±‚ â†’ è®¾è®¡ â†’ å¼€å‘ â†’ æµ‹è¯• (æ¨¡å— C)
```

**é€‚ç”¨åœºæ™¯**ï¼šåŠŸèƒ½è¾¹ç•Œæ¸…æ™°çš„æ¨¡å—åŒ–é¡¹ç›®

---

## æŠ€æœ¯å®ç°

### 1. ä»»åŠ¡ä¾èµ–å›¾

```python
class TaskDependencyAnalyzer:
    def analyze(self, tasks):
        """åˆ†æä»»åŠ¡ä¾èµ–å…³ç³»"""
        graph = {}
        for task in tasks:
            # åˆ†ææ¶‰åŠå“ªäº›æ–‡ä»¶/API
            files = self.extract_files(task)
            apis = self.extract_apis(task)

            # æ£€æŸ¥ä¾èµ–
            dependencies = []
            for other in tasks:
                if task == other:
                    continue
                # å¦‚æœå…¶ä»–ä»»åŠ¡ä¿®æ”¹äº†æœ¬ä»»åŠ¡ä¾èµ–çš„ API
                if self.depends_on(task, other):
                    dependencies.append(other.id)

            graph[task.id] = dependencies

        return graph

    def get_parallel_groups(self, graph):
        """è·å–å¯å¹¶è¡Œçš„ä»»åŠ¡ç»„"""
        # æ‹“æ‰‘æ’åº + åˆ†å±‚
        groups = []
        while graph:
            # æ‰¾å‡ºæ— ä¾èµ–çš„ä»»åŠ¡
            ready = [id for id, deps in graph.items() if not deps]
            if not ready:
                break  # å¾ªç¯ä¾èµ–
            groups.append(ready)
            # ç§»é™¤å·²å¤„ç†çš„ä»»åŠ¡
            for id in ready:
                del graph[id]
            # æ›´æ–°å‰©ä½™ä»»åŠ¡çš„ä¾èµ–
            for deps in graph.values():
                deps[:] = [d for d in deps if d not in ready]
        return groups
```

### 2. æ–‡ä»¶é”æœºåˆ¶

```python
class FileLockManager:
    def __init__(self, lock_dir="/tmp/agile-flow-locks"):
        self.lock_dir = lock_dir
        os.makedirs(lock_dir, exist_ok=True)

    def acquire(self, file_path, timeout=60):
        """è·å–æ–‡ä»¶é”"""
        lock_file = os.path.join(self.lock_dir, f"{hash(file_path)}.lock")
        start = time.time()
        while True:
            try:
                fd = os.open(lock_file, os.O_CREAT | os.O_EXCL | os.O_WRONLY)
                return fd
            except FileExistsError:
                if time.time() - start > timeout:
                    raise TimeoutError(f"æ— æ³•è·å–é”: {file_path}")
                time.sleep(0.5)

    def release(self, fd):
        """é‡Šæ”¾æ–‡ä»¶é”"""
        os.close(fd)
```

### 3. å¹¶è¡Œæ‰§è¡Œå™¨

```python
class ParallelTaskExecutor:
    def __init__(self, max_parallel=3):
        self.max_parallel = max_parallel
        self.file_locks = FileLockManager()
        self.port_pool = PortPool(start=3000, count=10)

    async def execute_group(self, tasks):
        """å¹¶è¡Œæ‰§è¡Œä¸€ç»„ä»»åŠ¡"""
        # æ£€æŸ¥æ–‡ä»¶å†²çª
        conflicts = self.check_file_conflicts(tasks)
        if conflicts:
            raise Exception(f"æ–‡ä»¶å†²çª: {conflicts}")

        # åˆ†é…ç«¯å£
        ports = self.port_pool.allocate(len(tasks))

        # å¹¶è¡Œæ‰§è¡Œ
        results = await asyncio.gather(*[
            self.execute_task(task, port)
            for task, port in zip(tasks, ports)
        ])

        # é‡Šæ”¾ç«¯å£
        self.port_pool.release(ports)
        return results

    def check_file_conflicts(self, tasks):
        """æ£€æŸ¥æ–‡ä»¶å†²çª"""
        file_map = {}
        conflicts = []
        for task in tasks:
            files = self.get_task_files(task)
            for file in files:
                if file in file_map:
                    conflicts.append((file_map[file], task.id))
                else:
                    file_map[file] = task.id
        return conflicts
```

---

## å®æ–½è®¡åˆ’

### é˜¶æ®µ 1ï¼šåŸºç¡€å¹¶è¡Œï¼ˆ1-2 å¤©ï¼‰
- [ ] å®ç°ä»»åŠ¡ä¾èµ–åˆ†æå™¨
- [ ] å®ç°æ–‡ä»¶é”æœºåˆ¶
- [ ] æ”¯æŒ 2-3 ä¸ªä»»åŠ¡å¹¶è¡Œå¼€å‘

### é˜¶æ®µ 2ï¼šæ™ºèƒ½è°ƒåº¦ï¼ˆ2-3 å¤©ï¼‰
- [ ] å®ç°ä»»åŠ¡åˆ†ç»„ç®—æ³•
- [ ] å®ç°åŠ¨æ€ç«¯å£åˆ†é…
- [ ] æ·»åŠ å†²çªè‡ªåŠ¨è§£å†³

### é˜¶æ®µ 3ï¼šä¼˜åŒ–æå‡ï¼ˆ1-2 å¤©ï¼‰
- [ ] æ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜
- [ ] å¤±è´¥é‡è¯•æœºåˆ¶
- [ ] å¹¶è¡Œåº¦è‡ªé€‚åº”è°ƒæ•´

---

## é¢„æœŸæ”¶ç›Š

### æ€§èƒ½æå‡
- **3 ä¸ªå¹¶è¡Œä»»åŠ¡**ï¼šæ€»è€—æ—¶å‡å°‘ ~60%
- **5 ä¸ªå¹¶è¡Œä»»åŠ¡**ï¼šæ€»è€—æ—¶å‡å°‘ ~75%

### ç¤ºä¾‹è®¡ç®—
```
ä¸²è¡Œ: 10ä»»åŠ¡ Ã— 30åˆ†é’Ÿ = 300åˆ†é’Ÿ (5å°æ—¶)
å¹¶è¡Œ(3): 4ç»„ Ã— 30åˆ†é’Ÿ = 120åˆ†é’Ÿ (2å°æ—¶) â† æå‡ 60%
å¹¶è¡Œ(5): 2ç»„ Ã— 30åˆ†é’Ÿ = 60åˆ†é’Ÿ (1å°æ—¶)  â† æå‡ 80%
```

---

## é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| ä»£ç å†²çª | é«˜ | æ–‡ä»¶é” + æ™ºèƒ½åˆ†ç»„ |
| èµ„æºç«äº‰ | ä¸­ | ç«¯å£æ±  + å®¹å™¨éš”ç¦» |
| ä¾èµ–é”™è¯¯ | ä¸­ | ä¾èµ–åˆ†æ + äººå·¥å®¡æ ¸ |
| è°ƒè¯•å›°éš¾ | ä½ | è¯¦ç»†æ—¥å¿— + ç‹¬ç«‹ transcript |
