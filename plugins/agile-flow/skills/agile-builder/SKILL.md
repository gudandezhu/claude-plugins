---
name: agile-builder
description: TDD 开发技能：先写完整测试用例，确保全部通过，循环处理 pending 任务
version: 8.0.0
---

# Agile Builder

按严格 TDD 流程开发任务，循环处理所有 pending 任务。

**核心原则**：功能完全测试完整，开发前写好所有测试用例，全部通过才 OK。

## TDD 流程（严格 7 步骤）

1. **编写完整测试用例** - 覆盖所有场景（正常、边界、异常）
2. **运行测试（红）** - 确认所有测试失败
3. **编写最小代码（绿）** - 使测试通过
4. **运行测试（全绿）** - 确保所有测试通过 ⚠️ 必须全部通过
5. **检查覆盖率** - 确保 ≥80%
6. **重构** - 优化结构（保持测试全绿）
7. **代码审核** - 使用 `/pr-review-toolkit:code-reviewer`

## 执行步骤

### 循环处理任务

1. **获取任务列表**
   ```bash
   node ${CLAUDE_PLUGIN_ROOT}/scripts/utils/tasks.js list
   ```

2. **处理每个 pending 任务**
   - 获取任务详情：
     ```bash
     node ${CLAUDE_PLUGIN_ROOT}/scripts/utils/tasks.js get-detail <TASK_ID>
     ```
   - 检查依赖任务状态
   - **执行严格 TDD 流程**（见下方）
   - 更新任务状态为 `tested`（跳过 `testing` 状态）
     ```bash
     node ${CLAUDE_PLUGIN_ROOT}/scripts/utils/tasks.js update <TASK_ID> tested
     ```

3. **循环直到无 pending 任务**
   - 继续获取下一个 pending 任务
   - 重复上述流程
   - 直到所有 pending 任务处理完成

4. **退出**

## 严格 TDD 流程（每个任务）

### 第 1 步：编写完整测试用例（最重要）

**必须覆盖所有场景**：
- ✅ 正常场景（Happy Path）
- ✅ 边界值测试（空值、极值）
- ✅ 异常场景（错误输入、异常情况）
- ✅ 集成场景（与其他模块交互）

**测试用例完整性检查**：
- 是否覆盖所有函数/方法？
- 是否覆盖所有分支（if/else）？
- 是否覆盖所有边界条件？
- 是否覆盖所有错误处理？

### 第 2 步：运行测试（红）
- 运行测试套件
- 确认所有新测试失败（因为还没实现功能）
- 如果有测试通过，说明测试用例有问题

### 第 3 步：编写最小代码（绿）
- 编写最少代码使测试通过
- 不要过度设计
- 先实现功能，后优化

### 第 4 步：运行测试（全绿）⚠️ 关键
- **必须所有测试通过**
- **即使只有一个测试失败也不算完成**
- 检查测试结果：
  ```bash
  # 示例输出
  ✅ PASS: 正常场景
  ✅ PASS: 边界值测试
  ✅ PASS: 异常场景
  ✅ PASS: 集成场景
  All tests passed! ✓
  ```
- 如果有失败，修复代码直到全绿

### 第 5 步：检查覆盖率
- 运行覆盖率测试
- 确保覆盖率 ≥ 80%
- 如果不足，补充测试用例

### 第 6 步：重构
- 优化代码结构
- **保持测试全绿**
- 重构后重新运行所有测试

### 第 7 步：代码审核
- 使用 `/pr-review-toolkit:code-reviewer` 进行代码审核
- 修复发现的问题

## 输出要求

- 最多一行（如 `✓ TASK-001 → tested (12 tests passed)`）
- 必须显示通过的测试数量
- 不输出详细步骤
- 最多 30 字
